{"title":"實作「使用 Discord 登入」","slug":"login-with-discord","html":"<ul>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"https://qiita.com/masayoshi4649/items/46fdb744cb8255f5eb98\">「Discord の ID でログイン」を実装する(Oauth2) - Qiita</a></li>\n</ul>\n<h2 id=\"1-於-discord-developer-portal-登錄-application\">1. 於 Discord Developer Portal 登錄 Application</h2>\n<h3 id=\"a-取得-「client-id」和「client-secert」\">a. 取得 「Client ID」和「Client Secert」</h3>\n<ol>\n<li>登入 <a target=\"_blank\" rel=\"nofollow\" href=\"https://discord.com/developers/applications\">Discord Developer Portal</a></li>\n<li>點擊右上角的「New Application」</li>\n<li>取名，本文範例取為 <code>OAuth Vertify</code>，此名稱會顯示於授權頁面上，之後點擊「Create」</li>\n<li>資訊頁右方的 <code>Client ID</code> 和 <code>Client Secert</code> 後面也會用到</li>\n</ol>\n<h3 id=\"b-建立-oauth-用的網址\">b. 建立 OAuth 用的網址</h3>\n<ol>\n<li>點擊左側的「OAuth2」分頁</li>\n<li>點擊右側的「Add Redirect」，輸入要用到驗證登入的網址\n<br/>例如本文最下方也有附上實作範例\n<br/>輸入的網址就是 <code>https://f6bfb5.github.io/login-with-discord/</code></li>\n<li>勾選下方「SCOPE」（索取的資訊欄位）\n裡的「identify」（Discord 的 ID）和「email」</li>\n<li>就可於頁面下方取得認證用的連結\n<br/>例：<code>https://discord.com/api/oauth2/authorize?client_id=</code>CLIENT ID<code>&amp;redirect_uri=</code>REDIRECT URL<code>&amp;response_type=code&amp;scope=</code>SCOPE</li>\n</ol>\n<h2 id=\"2-從認證連結取得「code」\">2. 從認證連結取得「code」</h2>\n<p>使用此認證連結登入，並重新導向到結果頁面後，網址上會多出一個回傳的 <code>code</code> 參數</p>\n<h2 id=\"3-使用「code」取得「token」\">3. 使用「code」取得「token」</h2>\n<p>再使用這個 <code>code</code> 去取得 <code>access_token</code>，才能得到存取資料的權限</p>\n<h3 id=\"a-傳送-post-請求到-discord-api\">a. 傳送 POST 請求到 Discord API</h3>\n<pre class=\"language-bash\"><code class=\"language-bash\">curl -X POST\n     -H \"Content-Type:application/x-www-form-urlencoded\"\n     -d \"client_id=CLIENT ID\n     &amp;client_secret=CLIENT SECRET\n     &amp;grant_type=authorization_code\n     &amp;code=CODE\n     &amp;redirect_uri=REDIRECT URL（要與認證 URL 相同）\"\n     https://discordapp.com/api/oauth2/token</code></pre><h3 id=\"b-若成功就可取得-access-token\">b. 若成功就可取得 <code>access token</code></h3>\n<pre class=\"language-json\"><code class=\"language-json\">{\n  \"access_token\": ACCESS TOKEN,\n  \"expires_in\": 604800,\n  \"refresh_token\": REFRESH TOKEN,\n  \"scope\": SCOPE,\n  \"token_type\": \"Bearer\"\n}</code></pre><ul>\n<li><code>code</code> 為一次性使用，同一個 <code>code</code> 無法進行第二次存取</li>\n<li><code>access token</code> 的有效期限為 604800 秒＝一個禮拜\n<br>若有更新需求，須使用回傳內容中的 <code>refresh token</code> 重新送出請求</li>\n</ul>\n<h2 id=\"4-使用「token」取得使用者資料\">4. 使用「token」取得使用者資料</h2>\n<h3 id=\"a-傳送-get-請求到-discord-api\">a. 傳送 GET 請求到 Discord API</h3>\n<pre class=\"language-bash\"><code class=\"language-bash\">curl -H \"Authorization: Bearer ACCESS TOKEN\"\n     https://discordapp.com/api/users/@me</code></pre><h3 id=\"b-若順利成功，就可取得相關資料\">b. 若順利成功，就可取得相關資料</h3>\n<pre class=\"language-json\"><code class=\"language-json\">{\n   \"id\": Discord ID,\n   \"username\": 使用者名稱,\n   \"avatar\": 大頭貼 ID,\n   \"discriminator\": 使用者編號（在名稱#後面的數字）,\n   \"public_flags\": 0,\n   \"flags\": 0,\n   \"email\": 信箱,\n   \"verified\": true,\n   \"locale\": 使用語言,\n   \"mfa_enabled\": false\n}</code></pre><ul>\n<li>頭像可以使用「<code>https://cdn.discordapp.com/avatars/</code>Discord ID<code>/</code>大頭貼 ID」取得</li>\n</ul>\n<h2 id=\"5-使用-refresh-token-重新取得-access-token\">5. 使用 refresh token 重新取得 access token</h2>\n<h3 id=\"a-傳送-post-請求到-discord-api-1\">a. 傳送 POST 請求到 Discord API</h3>\n<pre class=\"language-bash\"><code class=\"language-bash\">curl -X POST\n     -H \"Content-Type:application/x-www-form-urlencoded\"\n     -d \"client_id=CLIENT ID\n     &amp;client_secret=CLIENT SECRET\n     &amp;grant_type=refresh_token\n     &amp;refresh_token=REFRESH TOKEN\"\n     https://discordapp.com/api/oauth2/token</code></pre><h3 id=\"b-若成功就可取得-access-token-1\">b. 若成功就可取得 access token</h3>\n<pre class=\"language-json\"><code class=\"language-json\">{\n   \"access_token\": ACCESS TOKEN,\n   \"expires_in\": 604800,\n   \"refresh_token\": REFRESH TOKEN,\n   \"scope\": SCOPE,\n   \"token_type\": \"Bearer\"\n}</code></pre><h2 id=\"範例\">範例</h2>\n<p>以下示範透過此方式，取得你的 Discord ID 與大頭貼圖片。\n<br/>如果未顯示「Not logged in」或點擊按鍵無反應，請重新整理頁面。</p>\n<p><button id=\"js-discord-button\">Login with Discord</button>\n<span id=\"js-discord-status\" /></p>\n<div class=\"discord-card\" id=\"js-discord-card\" style=\"display: none\">\n  <img class=\"discord-card--image\" id=\"js-discord-card--image\">\n  <div class=\"discord-card--username\" id=\"js-discord-card--username\"></div>\n</div>\n\n<style>\n.discord-card--image {\n  margin-left: 0 !important;\n}\n</style>\n\n<script>\nconst clientID = \"798950274114781204\";\nconst redirectUri = \"https://f6bfb5.github.io/login-with-discord\";\nconst scope = \"identify email\"\n\nfunction handleClick() {\n   document.location.href = `https://discord.com/api/oauth2/authorize?client_id=${clientID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=code&scope=${encodeURIComponent(scope)}`;\n}\n\nwindow.addEventListener('load', function() {\n   document.getElementById(\"js-discord-button\").addEventListener(\"click\", handleClick);\n   // 1. get code from url params\n   const urlParams = new URLSearchParams(window.location.search);\n   if(urlParams.has(\"code\")) { \n     // 2. post code to get token\n     const clientSecret = \"3c-TeN5NxElL4la8E6h5BlT4zDHigser\";\n     const apiUrl = 'https://discordapp.com/api/oauth2/token'\n     const data = {\n        'client_id': clientID,\n        'client_secret': clientSecret,\n        'grant_type': 'authorization_code',\n        'code': urlParams.get(\"code\"),\n        'redirect_uri': redirectUri,\n        'scope': scope\n     }\n     // put payload together\n     const formBody = \n     Object.keys(data)\n     .map(key => encodeURIComponent(key) \n       + '=' \n       + encodeURIComponent(data[key]))\n     .join('&');\n     // send post\n     const resultData = fetch(apiUrl, {\n        method: \"POST\",\n        headers: {\n           \"content-type\": \"application/x-www-form-urlencoded\"\n        },\n        body: formBody,\n     })\n     .then(function(response) {\n        if( !response.ok ) {\n           throw new Error(response.statusText)\n        }\n        document.getElementById(\"js-discord-status\").innerText = \"token got\";\n        return response.json()\n     })\n     // 3. get user data\n     .then(function(data) {\n        let accessToken = data.access_token;\n        const userApiUrl = 'https://discordapp.com/api/users/@me';\n        return fetch(userApiUrl, {\n           method: \"GET\",\n           headers: {\n              \"authorization\": \"Bearer \" + accessToken,\n           }\n        })\n     })\n     .then(function(response) {\n        if( !response.ok ) {\n           throw new Error(response.statusText)\n        }\n        document.getElementById(\"js-discord-status\").innerText = \"user data got\";\n        return response.json();\n     })\n     .catch(function(error) {\n        document.getElementById(\"js-discord-status\").innerText = error;\n     })\n     // 4. display user data\n     resultData.then(function(r) {\n        if(r != undefined){\n          document.getElementById(\"js-discord-card\").style.display=\"block\";\n          document.getElementById(\"js-discord-card--image\").src=`https://cdn.discordapp.com/avatars/${r.id}/${r.avatar}`;\n          document.getElementById(\"js-discord-card--username\").innerText=`${r.username}#${r.discriminator}`\n        }\n     })\n   } else {\n      document.getElementById(\"js-discord-status\").innerText = \"Not logged in\";\n   }\n})\n</script>\n","date":"2021-01-14T00:24:23.000Z","printDate":"January 14, 2021","printReadingTime":"3 min read","tags":["F2E"],"image":"https://f6bfb5.github.io/preview/login-with-discord.png"}