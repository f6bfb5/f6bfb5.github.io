<!DOCTYPE html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta name="generator" content="Astro v3.3.0"><link rel="icon" href="/favicon.ico"><title>實作「使用Twitch登入」</title><!-- OGP --><meta property="og:url" content="https://f6bfb5.github.io/login-with-twitch.html"><meta property="og:type" content="article"><meta property="og:title" content="實作「使用Twitch登入」"><meta property="og:description" content=""><meta property="og:image" content="https://f6bfb5.github.io/images/login-with-twitch.png"><link rel="stylesheet" href="/_astro/_slug_.35185d57.css" />
<style>h1[data-astro-cid-gkspkard]{margin:.13em 0 .39em;font-size:3em;line-height:1.1;color:var(--title-color)}@media all and (max-width: 735px){h1[data-astro-cid-gkspkard]{max-width:80%;margin:auto;font-size:2.5em}}.title[data-astro-cid-gkspkard]{display:flex;flex-wrap:wrap;overflow:hidden;justify-content:center}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-8){animation:Title_red .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-7){animation:Title_orange .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-6){animation:Title_yellow .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-5){animation:Title_lime .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-4){animation:Title_green .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-3){animation:Title_cyan .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-2){animation:Title_blue .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n-1){animation:Title_purple .5s linear both}.title[data-astro-cid-gkspkard] span[data-astro-cid-gkspkard]:nth-child(9n){animation:Title_pink .5s linear both}@keyframes Title_red{0%{color:var(--bg-color);fill:transparent}50%{color:#e50020;fill:#e50020}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_orange{0%{color:var(--bg-color);fill:transparent}50%{color:#ec6c00;fill:#ec6c00}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_yellow{0%{color:var(--bg-color);fill:transparent}50%{color:#fbc600;fill:#fbc600}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_lime{0%{color:var(--bg-color);fill:transparent}50%{color:#6fba2c;fill:#6fba2c}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_green{0%{color:var(--bg-color);fill:transparent}50%{color:#008b38;fill:#008b38}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_cyan{0%{color:var(--bg-color);fill:transparent}50%{color:#009fe8;fill:#009fe8}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_blue{0%{color:var(--bg-color);fill:transparent}50%{color:#004da0;fill:#004da0}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_purple{0%{color:var(--bg-color);fill:transparent}50%{color:#910782;fill:#910782}to{color:var(--title-color);fill:var(--title-color)}}@keyframes Title_pink{0%{color:var(--bg-color);fill:transparent}50%{color:#e40065;fill:#e40065}to{color:var(--title-color);fill:var(--title-color)}}article[data-astro-cid-5grsw2hi]{padding:10px;border:1px solid var(--subtitle-color);box-shadow:2px 2px 0 var(--subtext-color),4px 4px 0 var(--title-color);background-color:#e5edc8}
</style><script type="module">
</script>
<script type="module" src="/_astro/page.75c7f027.js"></script></head><html lang="zh-Hant-TW" data-astro-cid-37fxchfa><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta name="generator" content="Astro v3.3.0"><link rel="icon" href="/favicon.ico"></head><body data-astro-cid-37fxchfa><header data-astro-cid-pux6a34n><nav data-astro-cid-pux6a34n><a href="/" data-astro-cid-pux6a34n> トリコじかけの明け暮れ</a><a href="/rss.xml" target="_blank" data-astro-cid-pux6a34n> rss</a><a style="display: none;" href="/sitemap.xml" target="_blank" data-astro-cid-pux6a34n> sitemap</a></nav></header><main class="container" data-astro-cid-37fxchfa><article data-astro-cid-5grsw2hi><h1 class="title" data-astro-cid-gkspkard><span style="animation-delay:125ms;width:" data-astro-cid-gkspkard>實</span><span style="animation-delay:150ms;width:" data-astro-cid-gkspkard>作</span><span style="animation-delay:175ms;width:" data-astro-cid-gkspkard>「</span><span style="animation-delay:200ms;width:" data-astro-cid-gkspkard>使</span><span style="animation-delay:225ms;width:" data-astro-cid-gkspkard>用</span><span style="animation-delay:250ms;width:" data-astro-cid-gkspkard>T</span><span style="animation-delay:275ms;width:" data-astro-cid-gkspkard>w</span><span style="animation-delay:300ms;width:" data-astro-cid-gkspkard>i</span><span style="animation-delay:325ms;width:" data-astro-cid-gkspkard>t</span><span style="animation-delay:350ms;width:" data-astro-cid-gkspkard>c</span><span style="animation-delay:375ms;width:" data-astro-cid-gkspkard>h</span><span style="animation-delay:400ms;width:" data-astro-cid-gkspkard>登</span><span style="animation-delay:425ms;width:" data-astro-cid-gkspkard>入</span><span style="animation-delay:450ms;width:" data-astro-cid-gkspkard>」</span></h1><h2 id="1-於-twitch-developers-console-登錄應用"><strong>1. 於 Twitch developers console 登錄應用</strong></h2>
<ol>
<li>登入 <a href="https://dev.twitch.tv/console/apps">Twitch Developers</a></li>
<li>「Register Your Application」</li>
<li>取名，本文範例取為「OAuth Verify」
<ul>
<li>此名稱會顯示於授權頁面上</li>
<li>以及輸入驗證完後重導向的網址
<ul>
<li>也就是要用於驗證登入的網址</li>
<li>本文實作範例的網址就是此頁面連結：
<ul>
<li><code>https://f6bfb5.github.io/login-with-twitch</code></li>
</ul>
</li>
</ul>
</li>
<li>「Create」</li>
</ul>
</li>
<li>「Manage」取得 <code>Client ID</code>，之後會用到</li>
</ol>
<h2 id="2-進行認證取得-access-token"><strong>2. 進行認證取得 access token</strong></h2>
<ul>
<li>Twitch API 分有兩種 access token
<ul>
<li>User access tokens
<ul>
<li>用於需要使用者授權才能存取的資源</li>
<li>例如取得聊天室使用者清單、使用者的信箱</li>
</ul>
</li>
<li>App access tokens
<ul>
<li>用於不需要使用者授權就能取得的資源</li>
<li>例如取得使用者的影片一覽</li>
</ul>
</li>
<li>其中 User access tokens 有兩種授權認證方式可取得
<ul>
<li>Implicit grant flow
<ul>
<li>用於不需要伺服器的應用</li>
</ul>
</li>
<li>Authorization code grant flow
<ul>
<li>用於需要伺服器的應用</li>
<li>可以儲存 client secret，以及傳送伺服器請求</li>
</ul>
</li>
<li>並各提供兩種認證機制
<ul>
<li>OAuth</li>
<li>OpenID Connect
<ul>
<li>基於 OAuth 2.0 的簡易認證層</li>
<li>會另有一個以 JSON Web Token 編碼身份令牌的 ID token</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>App access tokens 則是透過 OAuth Client Credentials Flow 取得
<ul>
<li>詳細可參照 <a href="https://dev.twitch.tv/docs/authentication/#user-access-tokens">Authentication</a></li>
</ul>
</li>
</ul>
</li>
<li>以 OAuth Implicit Code Flow 為範例</li>
</ul>
<ol>
<li>建立 OAuth 用的網址
<ul>
<li><code>https://id.twitch.tv/oauth2/authorize?response_type=token&#x26;client_id=</code>[CLIENT ID]<code>&#x26;redirect_uri=</code>[REDIRECT URL]<code>&#x26;scope=</code>[SCOPE]</li>
<li>Client ID
<ul>
<li>於第一步取得</li>
</ul>
</li>
<li>Redirect URL
<ul>
<li>重導向網址</li>
<li>本文範例以此頁面作為連結</li>
</ul>
</li>
<li>Scope
<ul>
<li>要取得的授權內容</li>
<li><a href="https://dev.twitch.tv/docs/authentication/scopes/#twitch-api-scopes">Twitch Access Token Scopes</a></li>
</ul>
</li>
</ul>
</li>
<li>驗證之後取得 access token
<ul>
<li>Implicit grant flow 會將 access token 回傳到網址上
<ul>
<li>JavaScript 可使用 <code>document.location.hash</code> 取得</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="3-使用-access-token-取得使用者資料"><strong>3. 使用 access token 取得使用者資料</strong></h2>
<ul>
<li>使用 access token 即可取得使用者資料
<ul>
<li><a href="https://dev.twitch.tv/docs/api/reference/#get-users">Get Users</a></li>
<li>
<pre class="astro-code dracula" style="background-color:#282A36;color:#F8F8F2; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> userApiUrl </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">https://api.twitch.tv/helix/users</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> urlParams </span><span style="color:#FF79C6">=</span><span style="color:#FF79C6;font-weight:bold"> new</span><span style="color:#50FA7B"> URLSearchParams</span><span style="color:#F8F8F2">(window.location.hash);</span></span>
<span class="line"><span style="color:#FF79C6">const</span><span style="color:#F8F8F2"> resultData </span><span style="color:#FF79C6">=</span><span style="color:#50FA7B"> fetch</span><span style="color:#F8F8F2">(userApiUrl, {</span></span>
<span class="line"><span style="color:#F8F8F2">  method</span><span style="color:#FF79C6">:</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">GET</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">,</span></span>
<span class="line"><span style="color:#F8F8F2">  headers</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> {</span></span>
<span class="line"><span style="color:#6272A4">    // 從網址取得重導向回傳的 access token</span></span>
<span class="line"><span style="color:#F8F8F2">    Authorization</span><span style="color:#FF79C6">:</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">Bearer </span><span style="color:#E9F284">"</span><span style="color:#FF79C6"> +</span><span style="color:#F8F8F2"> urlParams.</span><span style="color:#50FA7B">get</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">#access_token</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">),</span></span>
<span class="line"><span style="color:#E9F284">    "</span><span style="color:#F1FA8C">Client-Id</span><span style="color:#E9F284">"</span><span style="color:#FF79C6">:</span><span style="color:#F8F8F2"> clientID,</span></span>
<span class="line"><span style="color:#F8F8F2">  },</span></span>
<span class="line"><span style="color:#F8F8F2">})</span></span>
<span class="line"><span style="color:#F8F8F2">  .</span><span style="color:#50FA7B">then</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">function</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C;font-style:italic">response</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    return</span><span style="color:#F8F8F2"> response.</span><span style="color:#50FA7B">json</span><span style="color:#F8F8F2">();</span></span>
<span class="line"><span style="color:#F8F8F2">  })</span></span>
<span class="line"><span style="color:#F8F8F2">  .</span><span style="color:#50FA7B">then</span><span style="color:#F8F8F2">(</span><span style="color:#FF79C6">function</span><span style="color:#F8F8F2"> (</span><span style="color:#FFB86C;font-style:italic">r</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#FF79C6">    if</span><span style="color:#F8F8F2"> (r </span><span style="color:#FF79C6">!=</span><span style="color:#BD93F9"> undefined</span><span style="color:#F8F8F2">) {</span></span>
<span class="line"><span style="color:#F8F8F2">      document.</span><span style="color:#50FA7B">getElementById</span><span style="color:#F8F8F2">(</span><span style="color:#E9F284">"</span><span style="color:#F1FA8C">js-twitch-card</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">).style.display </span><span style="color:#FF79C6">=</span><span style="color:#E9F284"> "</span><span style="color:#F1FA8C">block</span><span style="color:#E9F284">"</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#6272A4">      // 資料會位於回傳的 data 屬性裡</span></span>
<span class="line"><span style="color:#F8F8F2">      document.</span><span style="color:#50FA7B">getElementById</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#E9F284">        "</span><span style="color:#F1FA8C">js-twitch-card--image</span><span style="color:#E9F284">"</span></span>
<span class="line"><span style="color:#F8F8F2">      ).src </span><span style="color:#FF79C6">=</span><span style="color:#F1FA8C"> `</span><span style="color:#FF79C6">${</span><span style="color:#F8F8F2">r.data[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">].profile_image_url</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">`</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">      document.</span><span style="color:#50FA7B">getElementById</span><span style="color:#F8F8F2">(</span></span>
<span class="line"><span style="color:#E9F284">        "</span><span style="color:#F1FA8C">js-twitch-card--username</span><span style="color:#E9F284">"</span></span>
<span class="line"><span style="color:#F8F8F2">      ).innerText </span><span style="color:#FF79C6">=</span><span style="color:#F1FA8C"> `</span><span style="color:#FF79C6">${</span><span style="color:#F8F8F2">r.data[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">].login</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">(</span><span style="color:#FF79C6">${</span><span style="color:#F8F8F2">r.data[</span><span style="color:#BD93F9">0</span><span style="color:#F8F8F2">].display_name</span><span style="color:#FF79C6">}</span><span style="color:#F1FA8C">)`</span><span style="color:#F8F8F2">;</span></span>
<span class="line"><span style="color:#F8F8F2">    }</span></span>
<span class="line"><span style="color:#F8F8F2">  });</span></span></code></pre>
</li>
</ul>
</li>
<li>API 一覽：<a href="https://dev.twitch.tv/docs/api/reference/">Reference</a></li>
</ul>
<h2 id="範例"><strong>範例</strong></h2>
<p><button id="js-twitch-button">Login with Twitch</button>
<span id="js-twitch-status"></span></p>
<div class="twitch-card" id="js-twitch-card" style="display: none">
  <img alt="profile" class="twitch-card--image" id="js-twitch-card--image">
  <div class="twitch-card--username" id="js-twitch-card--username"></div>
</div>
<style>
.twitch-card--image {
  margin-left: 0 !important;
}
</style>
<script>
import { onMount } from "svelte";

const clientID = "duo2s0lhrxlom9n2h2z9gppy137xwn";
const redirectUri = "https://f6bfb5.github.io/login-with-twitch";
// const redirectUri = "http://localhost:3000/login-with-twitch";
const scope = "";
// const scope = "user:read:email";

function handleClick() {
  document.location.href = `https://id.twitch.tv/oauth2/authorize
?client_id=${clientID}
&redirect_uri=${encodeURIComponent(redirectUri)}
&response_type=token
&scope=${encodeURIComponent(scope)}`;
}

onMount(() => {
  document.getElementById("js-twitch-button").addEventListener("click", handleClick);

  // 1. check if access token exists in url params
  const urlParams = new URLSearchParams(window.location.hash);
  if (urlParams.has("#access_token")) {
    // 2. send fetch
    const userApiUrl = "https://api.twitch.tv/helix/users";
    const resultData = fetch(userApiUrl, {
      method: "GET",
      headers: {
        "Authorization": "Bearer " + urlParams.get("#access_token"),
        "Client-Id": clientID,
      },
    }).then(function(response) {
      if (!response.ok) {
        throw new Error(response.statusText);
      }
      document.getElementById("js-twitch-status").innerText = "user data got";
      return response.json();
    }).catch(function(error) {
      document.getElementById("js-twitch-status").innerText = error;
    });
    // 4. display user data
    resultData.then(function(r) {
      if (r != undefined) {
        document.getElementById("js-twitch-card").style.display = "block";
        document.getElementById("js-twitch-card--image").src = `${r.data[0].profile_image_url}`;
        document.getElementById("js-twitch-card--username").innerText = `${r.data[0].login}(${r.data[0].display_name})`;
      }
    });
  } else {
    document.getElementById("js-twitch-status").innerText = "Not logged in";
  }
});
</script></article></main><footer data-astro-cid-sz7xmlte><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-sz7xmlte>
CC BY-NC-SA 4.0
</a><div class="right" data-astro-cid-sz7xmlte>
Made with <span class="heart" data-astro-cid-sz7xmlte>❤️</span> and
<a href="https://astro.new/" target="_blank" rel="noreferrer noopener nofollow" data-astro-cid-sz7xmlte>
Astro
</a></div></footer></body><script async src="https://www.googletagmanager.com/gtag/js?id=G-CRDP7WTXSQ"></script><script>
window.dataLayer = window.dataLayer || [];
function gtag() {
  dataLayer.push(arguments);
}
gtag("js", new Date());

gtag("config", "G-CRDP7WTXSQ");
</script></html>