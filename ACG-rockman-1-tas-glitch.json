{"title":"洛克人 1 的呼叫 Ending 漏洞機制解說","slug":"ACG-rockman-1-tas-glitch","html":"<h2 id=\"介紹\">介紹</h2>\n<p>2014 年 5 月，遊戲圈出現了一支使用輔助程式，在<strong>半分鐘內</strong>通關《洛克人 1》的破天荒影片，而這種需要經過精密的機制解析，與流程操控的遊戲通關方式，僅隔一個月竟然出現人力操作達成同樣的成果，人類無極限！本文會對其所使用的機制與流程進行解說。</p>\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/u5qom2q7cUU\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n△【TAS】 ロックマン 1 in 00:32.11 【任意コード実行】\n\n<h2 id=\"tas-與-ace\">TAS 與 ACE</h2>\n<p>在介紹這次主題的遊戲漏洞前，先為不熟悉的的讀者解釋一下所謂的「TAS」以及「ACE」是什麼，\n「TAS」指的是「<strong>使用工具輔助做出的競速通關 / 炫技遊玩（Tool-Assisted Speedrun / Superplay）</strong>」，具體來說，會使用像是遊戲模擬器上搭載的輔助功能，減慢遊戲整體執行速度、逐格操作、快速存檔 / 讀取、記憶體觀察…等等，藉此達成在理論上可能但實際難度非常高的遊玩技巧。</p>\n<p>「ACE」則是「<strong>執行任意代碼（Arbitrary Code Execution）</strong>」，這邊的「代碼」其實就是程式碼的意思，指使用遊戲軟、硬體安全性上的漏洞，去執行任何程式碼，講白了就是用遊戲操作寫程式，常見手法有如本文的直接呼叫（跳至）遊戲結局。</p>\n<h2 id=\"tas-使用機制\">TAS 使用機制</h2>\n<h3 id=\"delayobjectffglitch-技巧\">DelayObjectFFGlitch 技巧</h3>\n<p>在《洛克人 1》裡，當洛克人經過特定地圖的某些地點後，會出現不可視的「<code>0xFF</code>」物件（後稱 <code>FF 物件</code>）。例如 Ice Man 關卡的此處：</p>\n<p><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/FZkBQwv.gif\"><img src=\"https://i.imgur.com/FZkBQwv.gif\" alt=\"img01\"></a></p>\n<p>△ 「<code>0xFF</code>」物件出現於畫面不可視之處</p>\n<p>這個物件會讓影像處理單位（PPU, Picture Processing Unit）進行 Pattern Table Remap。推測是用於重新建構畫面用的物件。</p>\n<p>在正常情況的程式執行流程是 <code>1. 物件 FF 出現</code> → <code>2. 處理物件 FF（讀取 Bank 2 的資料）</code> → <code>3. 切換至 Bank 6</code> → <code>4. 讀取敵人資料編號</code>。</p>\n<p>若是在切換 Bank 之前，經由<strong>特定的操作</strong>超載待處理的指令量，會導致未切換至 Bank 6 之前，就直接在 Bank 2 讀取敵人編號的資料，造成畫面異常或是出現錯誤的敵人。</p>\n<p>敵人的 AI 舉動是在 <code>0x00</code>～<code>0x3A</code> 這個範圍裡的物件資料，程式流程是「執行敵人的 AI 程式 → 從物件編號得出要 jump 的（下一個資料的）目標 → 執行目標位置的 AI 程式」，因此使用 Delay Object 技巧，會讓最後的目標變成範圍外的物件，造成各種問題。</p>\n<p>例如物件 <code>F5</code> 出現後，需要執行敵人行動的 AI 模式 → 由於未切換 Bank，物件編號得到的 jump 目標為「<code>C0BD</code>」→ <code>C0BD</code> 為「通關處理過程中的物件」位置，因此遊戲會突然通關。</p>\n<p><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/pwkEkYJ.gif\"><img src=\"https://i.imgur.com/pwkEkYJ.gif\" alt=\"img02\"></a></p>\n<p>△ 異常出現的 Electric Man</p>\n<p>而 jump 目標詳細來說，系統會從 <code>$AA3B</code> + 2×（物件編號）取得 <a target=\"_blank\" rel=\"nofollow\" href=\"http://www.yuko2ch.net/rockman/JumpAddressList.txt\">AI 位置</a>，故物件編號為 <code>0x15</code> 時，目標位置會是 <code>$AA3B</code> + 2×0x15 = <code>$AA65</code> 裡所儲存的值，因此跳至儲存的「<code>B23C</code>」執行 AI。</p>\n<p>可能出現的各種物件 00 ～ FF 中，大部份的物件會造成遊戲重新開始或無法繼續遊玩，在上例的 Ice Man TAS 的實際運用裡，是發現 <code>$23</code>（每 frame 增加 1 的計數器）的值走至 55 時，有可能會出現「物件 55」，之後再藉由<strong>調整道具的出現量、音樂的演奏變化時間點、 rock buster 的高低座標</strong>得到想要的後續目標位置。</p>\n<p>套用計算法，<code>$AA3B</code> + 2×0x55 = <code>$AAE5</code>，裡頭儲存的 AI 位置為「<code>$600</code>」，搭配下列操作調整相關資料：</p>\n<table>\n<thead>\n<tr>\n<th>位置</th>\n<th>數值</th>\n<th>行為</th>\n<th>如何調整</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>0600</td>\n<td>54 F8</td>\n<td>NOP F8,X（什麼都不做，往下執行 ）</td>\n<td>移動洛克人的 Y 座標 =54</td>\n</tr>\n<tr>\n<td>0602</td>\n<td>50 4D</td>\n<td>BVC <code>$0651</code>（jump 至 <code>$651</code>）</td>\n<td>調整 rock buster 第 1 發和第 2 發的 Y 座標 =50, 4D</td>\n</tr>\n<tr>\n<td>0650</td>\n<td>3C</td>\n<td>UNDEFINED（這裡不會執行）</td>\n<td>delay FF 出現物件 3 的 ObjectFireDelay=3C</td>\n</tr>\n<tr>\n<td>0651</td>\n<td>AD 22 1F</td>\n<td>LDA <code>$1F22</code>=#<code>$0A</code>（讀取 0x0A 裡的 <code>$1F22</code> 並儲存至 A 暫存器）</td>\n<td>擊倒普通的敵人掉落道具的 ObjectFireDelay=AD,22<br>delay FF 出現的物件 1 的 ObjectFireDelay=1F</td>\n</tr>\n<tr>\n<td>0654</td>\n<td>6C 18 00</td>\n<td>JMP (<code>$0018</code>)=<code>$C460</code>（<code>$C460</code>: jump 至通關處理的途中）</td>\n<td>擊倒普通的敵人掉落道具的 ObjectFireDelay=6C,18<br>delay FF 出現的物件 55 的 ObjectFireDelay=00<br><code>$0018</code> 的數値由操作控制器 1 的「左下」+ 控制器 2 的「左右 Select」=60,C4</td>\n</tr>\n</tbody></table>\n<p>C45E: A9 00 lda #$00\n<br>C460: 85 31 sta $31(CurrentStage)　 ← 遊戲程式會 jump 至這裡並進行中斷處理\n<br>C462: 4C 0C C1 jmp $C10C</p>\n<p>進入遊戲 ending。</p>\n<p>利用這個漏洞，就能在事先準備好讀取的資料後，達成想要的操作結果。</p>\n<h3 id=\"doubleobjectffglitch\">DoubleObjectFFGlitch</h3>\n<ol>\n<li>在物件 FF 會出現的地方來回移動</li>\n<li>物件 FF 出現後，會在 16 frames 裡每 frame 進行一次物件 FF 的處理</li>\n<li>在物件 FF 進行處理的 frame 裡，讓物件 FF 朝左出現</li>\n<li>會變為從 Bank 2 讀入錯誤的物件</li>\n</ol>\n<p>同樣的，由調整 <code>$23</code>（每 frame 增加 1 的計數器）決定讀入的物件，以下則是一些有趣的物件：</p>\n<ul>\n<li><code>75</code>、<code>F5</code>: 通過該關卡，但下一關開始會破圖。</li>\n<li><code>4A</code> : 出現後，過一段時間通過該關卡，下一關的關卡圖像正常。</li>\n<li><code>42</code> : 磁力條，由於看不見、初始座標會變動、會往 11 點鐘方向並馬上消失，因此難以取得，在晃動人物時偶爾會有成功取得的狀況。</li>\n</ul>\n<p>一旦某項物件出現後，在其消滅之前都不會再出現下個物件，若出現了目標之外的物件，就要用離開畫面之類的手法來清除。</p>\n<p><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/LEoXwhg.gif\"><img src=\"https://i.imgur.com/LEoXwhg.gif\" alt=\"img03\"></a></p>\n<p><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/b0naPNm.gif\"><img src=\"https://i.imgur.com/b0naPNm.gif\" alt=\"img04\"></a></p>\n<p><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/xO6xO8i.gif\"><img src=\"https://i.imgur.com/xO6xO8i.gif\" alt=\"img05\"></a></p>\n<p>△ 本次 RTA 的關鍵地點</p>\n<p>在氣力人關卡的圖片位置三處，進行 DoubleObjectFFGlitch（在圖片的位置左右移動）就會將 <code>$17</code>（控制器 2）做為下一個讀取的物件編號，因此可由控制器 2 的數值決定物件 00 ～ FF 的出現。</p>\n<p>若是同時按住控制器 2 的「左、上、下、Select、A」鍵，會出現物件 75 ，通過目前關卡，但下一關會破圖。</p>\n<p>※兩者的差異應該是在，前者使用增加畫面道具量造成的處理延遲，去影響物件的產生，後者利用物件出現的方向，因此原文解說內有註明，後者技巧只需要來回移動，不需加上處理 delay 。</p>\n<h2 id=\"人力-rta\">人力 RTA</h2>\n<iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/SoUd69Xs9gg\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen></iframe>\n\n<p>△【RTA】ロックマン in3:53【2014-06-21】</p>\n<h3 id=\"目標\">目標</h3>\n<p>將記憶體調整成下列的對應數值後 :</p>\n<table>\n<thead>\n<tr>\n<th>位置</th>\n<th>數值</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><code>$482</code></td>\n<td>8A</td>\n</tr>\n<tr>\n<td><code>$483</code></td>\n<td>50</td>\n</tr>\n<tr>\n<td><code>$484</code></td>\n<td>13</td>\n</tr>\n<tr>\n<td><code>$498</code></td>\n<td>4A</td>\n</tr>\n<tr>\n<td><code>$499</code></td>\n<td>20</td>\n</tr>\n<tr>\n<td><code>$49A</code></td>\n<td>60</td>\n</tr>\n<tr>\n<td><code>$49B</code></td>\n<td>C4</td>\n</tr>\n<tr>\n<td><code>$605</code></td>\n<td>20</td>\n</tr>\n<tr>\n<td><code>$606</code></td>\n<td>82</td>\n</tr>\n<tr>\n<td><code>$607</code></td>\n<td>04</td>\n</tr>\n</tbody></table>\n<p>進行 DoubleObjectFFGlitch 就會進入 Ending 畫面。</p>\n<h3 id=\"流程\">流程</h3>\n<ol>\n<li>在 Electric Man 的關卡裡，於梯子上進行射擊的動作，<strong>僅按下 1 frame</strong> 下鍵，會變為半抓住梯子的樣子，\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/5srrun8.jpg\"><img src=\"https://i.imgur.com/5srrun8.jpg\" alt=\"img06\"></a>\n<br>洛克人朝左的狀況下，按下上鍵，會變為頭卡在天花板的穿牆狀態，按下跳躍鍵，跳到最高處後，按下右鍵，會穿越至磁力條的右方，這個狀態下按左鍵，會由於子畫素（subpixel）的關係，有 1/8 的機率可以拿到磁力條，再按下一次跳躍鍵，就會回到穿牆狀態。</li>\n<li>進入 Guts Man 關卡</li>\n<li>在關卡開頭等待第二隻小矮兵的 3 連攻擊，在下圖的位置等待至第 3 發中央的子彈消失於畫面外後， <code>$49B</code> 的值會變為 C4 。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/EhAhmrY.jpg\"><img src=\"https://i.imgur.com/EhAhmrY.jpg\" alt=\"img07\"></a></li>\n<li>在畫面內有 2 隻小矮兵的狀態下，<strong>保持畫面裡有 2 連攻擊</strong>追至下圖的位置，等待至第 2 發中央的子彈消失於畫面外後， <code>$49A</code> 的值會變為 60。\n<br>這裡若是遇到 3 連攻擊 <code>$49B</code> 會因此取得 C4 之外的值。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/fAcJeMt.jpg\"><img src=\"https://i.imgur.com/fAcJeMt.jpg\" alt=\"img08\"></a></li>\n<li>在畫面內有 1 隻小矮兵的狀態下，在下圖位置等待 2 連攻擊的第 2 發中央子彈消失於畫面外後， <code>$499</code> 的值會變為 20。\n<br>這裡同樣若是遇到 3 連攻擊，在這之前的調整會因此偏掉。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/O046zDW.jpg\"><img src=\"https://i.imgur.com/O046zDW.jpg\" alt=\"img09\"></a>\n<br>這裡小矮兵的攻擊間隔是由亂數決定，若是運氣不好，會有可能為了 3 連攻擊或 2 連攻擊，要等上數十秒。\n<br>若是途中失敗可從 <code>$49B</code> 重新開始調整。</li>\n<li>接下來要調整 <code>$498</code>，移動至斷崖的另一邊後，擊敗 3 隻敵人<strong>並使畫面上顯示 3 個道具</strong>後，在下圖的位置受到傷害，會使 <code>$498</code> 的值變為 4A 。\n<br>若是失敗仍可在血量允許的情況下持續調整。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/uFBy8hb.jpg\"><img src=\"https://i.imgur.com/uFBy8hb.jpg\" alt=\"img10\"></a></li>\n<li>接下來是 <code>$482</code>～<code>$484</code> 的調整，在下圖的位置向右連射 3 發 buster ，在第 3 發子彈消失於畫面外後，<code>$484</code> 的值會變為 13。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/5KVdRku.jpg\"><img src=\"https://i.imgur.com/5KVdRku.jpg\" alt=\"img11\"></a></li>\n<li>在下圖的位置向右連射 2 發 buster ，在第 2 發子彈消失於畫面外後，<code>$483</code> 的值會變為 50。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/ZKGmALT.jpg\"><img src=\"https://i.imgur.com/ZKGmALT.jpg\" alt=\"img12\"></a></li>\n<li>在下圖的位置向右射單發 buster ，子彈消失於畫面外後，<code>$482</code> 的值會變為 8A。\n<br>在這之後若再發射 buster，會造成先前調整的數值變動，<strong>要注意不可再使用 buster</strong> ，若是失敗則要再從 <code>$484</code> 開始重新調整。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/O95Y27D.jpg\"><img src=\"https://i.imgur.com/O95Y27D.jpg\" alt=\"img13\"></a></li>\n<li>接下來是 <code>$605</code>～<code>$607</code> 的調整，從第三階樓梯開始，使用磁力條逐格拉高 10 高度。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/ceJ1S7O.jpg\"><img src=\"https://i.imgur.com/ceJ1S7O.jpg\" alt=\"img14\"></a></li>\n<li>注意磁力條的顯示時間，將畫面最上方的磁力條調整為<strong>畫面裡出現的第 3 條</strong>， <code>$607</code> 的值會變為 04 。\n<br>需將時間調整為，這時踏台的第 2 條和第 1 條的磁力條，在設置第 3 條後會馬上消失。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/6qy17F2.jpg\"><img src=\"https://i.imgur.com/6qy17F2.jpg\" alt=\"img15\"></a></li>\n<li>在踏台的第 2 條磁力條消失前，射出磁力條並跳至最高，可以使用 Start → Select 微調磁力條至下圖的位置（與右邊的山峰平行）後，放開 B 鍵便能在此設置磁力條。\n<br>由於這時先前設值的第 1 和第 2 條磁力條已經消失了，這時設置的磁力條會變為第 1 條，<code>$605</code> 會變為 20 。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/uQmEdO7.jpg\"><img src=\"https://i.imgur.com/uQmEdO7.jpg\" alt=\"img16\"></a></li>\n<li>著地後朝左射出磁力條，並在最大跳躍後，在<strong>頂點附近</strong>朝右，將磁力條設置於如下圖的階梯上固定，這會是第 2 條磁力條，<code>$606</code> 變為 82 。\n<br>若是這時失敗會由於磁力條的殘量不足，必須整個 run 重來過。\n<br>若只是想成功可以從 <code>$484</code> 的調整重新開始。\n<br><a target=\"_blank\" rel=\"nofollow\" href=\"https://i.imgur.com/MPvesQN.jpg\"><img src=\"https://i.imgur.com/MPvesQN.jpg\" alt=\"img17\"></a></li>\n<li>調整至此<strong>必須沒有任何 1 格點陣</strong>的偏差，並且為了使用 DoubleObjectFFGlicth 叫出物件 55，需要<strong>按下控制器 2 的「←、↑、Select、A」鍵</strong>。\n<br>影片的跑者是使用膠帶固定住 A 鍵，用雙腳踩下十字鍵與 Select 鍵。\n<br>然而 Guts Man 關的 DoubleObjectFFGlicth 比起 Ice Man 的難易度更高，在人力執行上是一定程度的運 Game，這點只能不斷嘗試來達成。\n<br>而最重要的是，<strong>要在這 3 條磁力條消失前達成 DoubleObjectFFGlicth 的技巧</strong>，若是成功達成執行技巧，呼叫出物件 55，就會和 TAS 影片一樣突然進入 ending 。\n<br>磁力條消失的時間是 150 frames（約 2.5 秒左右），因此僅有大概 1 ～ 2 次的跳躍機會可嘗試，雖然單次 run 的整體時間很短，仍然是個極為困難的技巧。</li>\n</ol>\n<h2 id=\"參考文章：\">參考文章：</h2>\n<ul>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"http://www.yuko2ch.net/rockman/mm1tasmap.html\">ディレオブジェクトテク</a></li>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"http://ch.nicovideo.jp/TASVideos/blomaga/ar529967\">ロックマン 1 のディレイエンディング TAS について</a></li>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"http://ch.nicovideo.jp/TASVideos/blomaga/ar535617\">ロックマン 1 の新技：DoubleObjectFFGlitch について</a></li>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"http://ch.nicovideo.jp/nou/blomaga/ar558601\">ロックマン RTA における　任意コード実行テクニックについて</a></li>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"http://www.nicovideo.jp/watch/sm23553625\">ロックマン 1 in 00:32.11 の解説用動画</a></li>\n</ul>\n<h2 id=\"追記\">追記</h2>\n<ul>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"https://www.nicovideo.jp/watch/sm36192523\">【TAS】 ロックマン 1 in 00:27.04 【任意コード実行】</a></li>\n</ul>\n<p>在 2020 年的 1 月 6 號，ピロ彦 P 上傳了一支大幅更新版本的影片，\n這次把原本就很驚人的 32 秒紀錄再推進了 5 秒，全破《洛克人 1》只需要 27 秒！</p>\n<h3 id=\"機制簡記\">機制簡記</h3>\n<ul>\n<li>利用 Y 軸座標執行任意程式碼</li>\n<li>打大補 <code>$610</code> -&gt; 3A</li>\n<li>調整掉落道具高度 <code>3A ** 17 18</code> 產生 <code>55</code></li>\n<li>在 <code>$8C</code>=05 的 2px 位置調整成 NEXT=130 前後產生 <code>$17</code> 物件</li>\n<li>為了讓產生物件的 Y 座標變成 <code>$16</code> 先調整 <code>$611</code>=6C</li>\n<li>物件 <code>55</code> 不會執行純讀取資料（ROM）而會執行 RAM 的 <code>$600</code></li>\n<li><code>$600</code> 是岩男 Y 座標，<code>$601</code> 為 F8 固定值，<code>$602</code> 是第 3 發子彈的 Y 座標</li>\n<li>調整成 <code>48 F8 54 54 48 F8 F8</code> 程式就會執行至 <code>$610</code> 即敵人 Y 座標物件位址為止</li>\n<li>34 和 54 是 NOP（No Operation），F8 是 SED（Stream Editor）都是在紅白機上無功能的指令</li>\n<li>48 PHA 是把 A 暫存器的值推到 Stuck 上</li>\n<li>執行 <code>$600</code> 時 A 暫存器是 06 因此 Stuck 的值是 06 06</li>\n<li><code>$611</code> 之後的 <code>6C 17 18</code> JUMP 到 <code>$1817</code>（<code>$0017</code> 的鏡像複製值）的 16bit 值</li>\n<li><code>$17</code> 是 2P 在前一幀的輸入 <code>$18</code> 是 1P 的新輸入減去前一幀輸入</li>\n<li>在跳躍之前執行兩次 PHA 回傳的位置會變成 <code>$0606</code>+1</li>\n<li>第一次的跳躍讓 A 暫存器值變為 0A，第二次跳躍讓關卡變為 0A+1</li>\n<li>關卡的值（<code>$31</code>）變成 0B 進入 Ending</li>\n</ul>\n<h3 id=\"參考文章\">參考文章</h3>\n<ul>\n<li><a target=\"_blank\" rel=\"nofollow\" href=\"http://hp.vector.co.jp/authors/VA042397/nes/6502.html\">NES 研究室 - 6502</a></li>\n</ul>\n","date":"2019-02-19T13:59:42.000Z","excerpt":"2014 年 5 月，遊戲圈出現了一支使用輔助程式，在「半分鐘內」通關《洛克人 1》的破天荒影片，而這種需要經過精密的機制解析，與流程操控的遊戲通關方式，僅隔一個月竟然出現人力操作達成同樣的成果，人類無極限！","printDate":"February 19, 2019","printReadingTime":"5 min read","tags":["ACG","Game"],"image":""}